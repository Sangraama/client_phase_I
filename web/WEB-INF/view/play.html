<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>Sangrama</title>


</head>
<body>
 <canvas id="experiment-canvas"></canvas>


</body>


<script src="../js/resources/caat/Core/ModuleManager.js"></script>

<script type="text/javascript">
var director,scene,action;
(function() {
    /**
     * Startup it all up when the document is ready.
     * Change for your favorite frameworks initialization code.
     */
    window.addEventListener('load', load, false);

    function load() {
        CAAT.ModuleManager.
                baseURL("../js/resources/caat/").
                setModulePath("CAAT.Core", "Core").
                setModulePath("CAAT.Math", "Math").
                setModulePath("CAAT.Behavior", "Behavior").
                setModulePath("CAAT.Foundation", "Foundation").
                setModulePath("CAAT.Event", "Event").
                setModulePath("CAAT.PathUtil", "PathUtil").
                setModulePath("CAAT.Module", "Modules").
                setModulePath("CAAT.Module.Preloader", "Modules/Image/Preloader").
                setModulePath("CAAT.WebGL", "WebGL").

            // get modules, and solve their dependencies.
                bring(
                [
                    "CAAT.PathUtil.Path",
                    "CAAT.PathUtil.LinearPath",
                    "CAAT.Foundation.SpriteImage",
                    "CAAT.Foundation.Director",
                    "CAAT.Foundation.Actor",
                    "CAAT.Foundation.ActorContainer",
                    "CAAT.Behavior.PathBehavior",
                    "CAAT.Behavior.Interpolator",
                    "CAAT.Module.Preloader.Preloader"
                ]).

            // this function will be firer every time all dependencies have been solved.
            // if you call again bring, this function could be fired again.
                onReady(function () {
                    // simply load js files. call start when all of them have been loaded.
                    // load won't start until all 'bring' dependencies have been solved.

                    new CAAT.Module.Preloader.Preloader().
                            addElement("arrow", "../images/arrow.png").
                            addElement("fish2", "../images/arrow.png").
                            addElement("fish3", "../images/arrow.png").
                            addElement("fish4", "../images/arrow.png").
                            load(function onAllAssetsLoaded(images) {
                                sprites(images);
                            });

                });
    }

    function sprites(images) {
        CAAT.DEBUG = 1;
        director = new CAAT.Foundation.Director().initialize(800, 500, 'experiment-canvas');
        director.setImagesCache(images);
        scene = director.createScene();
        // when the scene is activated, avoid the director clearing the viewport since it'll be
        // totally erased by the background.
        scene.activated = function() {
            director.setClear(false);
        }

        var gradient = director.ctx.createLinearGradient(0, 0, director.width, director.height);
        gradient.addColorStop(0, '#000000');
        gradient.addColorStop(1, '#00007f');

        var gr = new CAAT.Foundation.ActorContainer().
                setBounds(0, 0, director.width, director.height).
                setFillStyle(gradient).
                enableEvents(false).
                cacheAsBitmap();

        scene.addChild(gr);

        gr.enableEvents(true);
        CAAT.loop(1);
    }


})();
function addPlayer(x, y) {

    var scale = Math.random() + .5;

    var fish = new CAAT.Foundation.Actor().
            setBackgroundImage(
            director.getImage('arrow'),
            true).
            setLocation(x, y).
            enableEvents(false);

    scene.addChild(fish);


}
function doKeyDown(evt) {
    switch (evt.keyCode) {
        case 38:  /* Up arrow was pressed */
            action = action + 'MOVE_UP';
            console.log('up pressed');
            break;
        case 40:  /* Down arrow was pressed */
            action = action + 'MOVE_DOWN';
            console.log('down pressed');
            break;
        case 37:  /* Left arrow was pressed */
            action = action + 'MOVE_LEFT';
            console.log('left pressed');
            break;
        case 39:  /* Right arrow was pressed */
            action = action + 'MOVE_RIGHT';
            console.log('right pressed');
            break;
        case 82: /* R was pressed */
            action = action + 'ROTATE_RIGHT';
            break;
        case 76: /* L was pressed */
            action = action + 'ROTATE_LEFT';
            break;
        case 32: /* Space was pressed */
            action = action + 'ANGLE_MOVE';
            break;
        default:
//                            alert(evt.keyCode);
    }
}
function doKeyUp(evt) {
    var regx;
    switch (evt.keyCode) {
        case 38:  /* Up arrow was released */

            regx = new RegExp('MOVE_UP', 'g');
            action = action.replace(regx, '');
            break;
        case 40:  /* Down arrow was released */
            regx = new RegExp('MOVE_DOWN', 'g');
            action = action.replace(regx, '');
            break;
        case 37:  /* Left arrow was released */
            regx = new RegExp('MOVE_LEFT', 'g');
            action = action.replace(regx, '');
            break;
        case 39:  /* Right arrow was released */
            regx = new RegExp('MOVE_RIGHT', 'g');
            action = action.replace(regx, '');
            break;
        case 82: /* R was released */
            regx = new RegExp('ROTATE_RIGHT', 'g');
            action = action.replace(regx, '');
            break;
        case 32: /* Space was released */
            regx = new RegExp('ANGLE_MOVE', 'g');
            action = action.replace(regx, '');
            break;
        case 76: /* L was released */
            regx = new RegExp('ROTATE_LEFT', 'g');
            action = action.replace(regx, '');
            break;
        default:
            alert(evt.keyCode);
    }
}
function doMouseDown(evt) {
    switch (evt.which) {
        case 1:
            action = action + 'SHOOT';
            addPlayer(evt.clientX,evt.clientY);
            break;
        case 2:
            alert('Middle mouse button pressed');
            break;
        case 3:
            alert('Right mouse button pressed');
            break;
        default:
            alert('You have a strange mouse');
    }
}
function doMouseUp(evt) {
    var regx;
    switch (evt.which) {
        case 1:
            regx = new RegExp('SHOOT', 'g');
            action = action.replace(regx, '');
            break;
        case 2:
            alert('Middle mouse button released');
            break;
        case 3:
            alert('Right mouse button released');
            break;
        default:
            alert('You have a strange mouse');
    }
}

var ws;
if ('MozWebSocket'  in window) {
    ws = new MozWebSocket('ws://localhost:8080/Server');
} else if ('WebSocket'  in window) {
    ws = new WebSocket('ws://localhost:8080/Server');
} else {
    alert('Your browser does not support WebSockets');
}
ws.onopen = function () {
    ws.send('Amila');

};
ws.onmessage = function (event) {
    var player = $.evalJSON(event.data);
    console.log('x:' + player.x + ' y:' + player.y);
};
ws.onclose = function () {
};
ws.onerror = function (event) {
};

window.addEventListener('keydown', doKeyDown, true);
window.addEventListener('keyup', doKeyUp, true);
window.addEventListener('mousedown', doMouseDown, true);
window.addEventListener('mouseup', doMouseUp, true);
</script>
</html>